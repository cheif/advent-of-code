import Foundation
import Shared

private struct Beam: Hashable {
    let position: Position
    let direction: Direction

    func move(direction: Direction? = nil) -> Beam {
        let dir = direction ?? self.direction
        return Beam(
            position: self.position.move(in: dir),
            direction: dir
        )
    }
}

private func step(grid: Grid<Character>, beams: [Beam]) -> [Beam] {
    beams.flatMap { beam -> [Beam] in
        let current = grid.points[beam.position]!.val
        switch (current, beam.direction) {
        case (".", _), ("-", .left), ("-", .right), ("|", .up), ("|", .down):
            return [beam.move()]
        case ("|", .left), ("|", .right):
            return [Direction.up, .down].map(beam.move(direction:))
        case ("-", .up), ("-", .down):
            return [Direction.left, .right].map(beam.move(direction:))
        case ("/", .right), ("\\", .left):
            return [beam.move(direction: .up)]
        case ("/", .up), ("\\", .down):
            return [beam.move(direction: .right)]
        case ("\\", .right), ("/", .left):
            return [beam.move(direction: .down)]
        case ("\\", .up), ("/", .down):
            return [beam.move(direction: .left)]
        default:
            fatalError("\(current), \(beam) not handled")
        }
    }.filter { grid.positions.contains($0.position) }
}

private func getEnergization(grid: Grid<Character>, start: Beam) -> Set<Position> {
    var toTest: [Beam] = [start]
    var allBeams = Set<Beam>(toTest)
    while !toTest.isEmpty {
        let next = step(grid: grid, beams: toTest)
        toTest = next.filter { !allBeams.contains($0) }
        allBeams.formUnion(toTest)
    }

    return Set(allBeams.map(\.position))
}

public let day16 = Solution(
    part1: { input in
        let grid = Grid(string: input)
        let energization = getEnergization(grid: grid, start: Beam(position: Position(x: 0, y: 0), direction: .right))
        return energization.count
    },
    part2: { input in
        let grid = Grid(string: input)
        let starts = grid.xRange.flatMap { x in [
            Beam(position: Position(x: x, y: 0), direction: .down),
            Beam(position: Position(x: x, y: grid.yRange.upperBound), direction: .up)
        ]} + grid.yRange.flatMap { y in [
            Beam(position: Position(x: 0, y: y), direction: .right),
            Beam(position: Position(x: grid.xRange.upperBound, y: y), direction: .left)
        ]}
        let best = starts.map { ($0, getEnergization(grid: grid, start: $0)) }.max(by: { $0.1.count < $1.1.count })!
        // 6988 is incorrect
        return best.1.count
    },
    testResult: (46, 51),
    testInput: #"""
.|...\....
|.-.\.....
.....|-...
........|.
..........
.........\
..../.\\..
.-.-/..|..
.|....-|.\
..//.|....
"""#,
    input: #"""
\\..../........-...-........-.-.|..................-...........................-.........-...---..............
..../.....................\...........|........|...........\...|./...-...|..|.|-.....-.....|........\....../..
............|...........\.....................\....|.....|/./........../.....................-................
.......\.|.\-....--../..........\.../.../.../......................\.............\............................
.............\/...../..........................|....-.....-.......\|...........-....|.........................
.-............-../......|.............-................../|....-...-....../|...-....--...\.......\..|.......-.
.......-......./....................\......................\.....|........../.......\............|..\../.../..
........................-.....\.......\........................./............................|......\..-......
...................-................./......|.....-....\\............./.....\.................................
.............|.........................\.|.....|\....../.......|..............\\../..................../......
-......\......./........\.-/...................|../-./................/.........................|......\.....|
..........................\...........................\...........................|...........................
....-...../|.............................-........./...-..................|..........\..\................\....
............/........-.-.................//..\................................-.......|.-............//....-..
.......-.....|.\........\...|....-......./......\.......-.......\...................../...\...................
...\.|..-........./........................-.....|..-............................\..-.........................
..../.........................................--.............|...................................\..../....../
..........\...........--........./.|.......\./................/.........\.|..|......\........-//............./
...\.|..\......\.......-\........\|......./.......\..|...........-..............\-..|...................\.....
..../........|..|.........................../..\....................|.......\.......................-........\
.....\.......\...\.|.........\.................|......|..-...................-.../.\...................|......
........\................./..............-....-..................|.....\|\................./...../............
.|................\../..........................|.....\.......................................................
...|.........................|........|...|...\.-.-...................\..|./..\\......|.../..................-
......-..................................|.................................\.|.\..-........\..................
.-..........\|..-.....-.\..-...............\........-.....................-.....|....................\..|.....
..../....-..............................-\................................................................../.
............./....................\...................|...........\.../.............-......-....-.............
........../....../..-.|.............\\......../.....................|....-..........\.........\....../........
.............|......\......../../..........|...........-......\|........\...........././....\..........|......
......-................../.....-................-..............\.-..............|................|............
...-...-./..................................................|.\..\........\-........-.................\.......
.......................\.\.........|................\....../.|....\.../..\.|\.....-.|..............-..........
..-.........-|...\.\....|.-.\........................\........................./.-................/..........-
.........|.......-.................\/......../...............\..|..................|....|..\..|.............\.
......\........................-......\..-...-..........-......./....\........................\..............-
.......\...-....\\...........................\......................./..|../........./................|....../
...............|...|..\..-......................../............\-............/.\..........-........|.........\
...-..\......|......\............/................/...\../.|../...........|-...........\.........\.....-..|...
.........\.....-......|..................-.....................................................-.............|
....../.....|.................|./....-\......................|...-..............|...\..-.......|.......-../...
................................/............\..........\................./............\.-.....|............/.
........\.............\.......|..................-.......................-....................................
....-.-................\..............-......-.../............\............................../|...............
............................\.\..........././........|..\/....-|...................\.......-...../.\..........
-.................../...\....../.|.........................../..........\...........\..........|......-.......
...|-|...............|...\..../|.............-...............\.........-....|-...................|............
..\\.......\.....|....\./\............./.|...../...\...........................-.......--......-.......\\.....
....-..//...../....................|....-...../\..................................|......................-....
......................................../..-...................../.......|.--......\....|..-..\...............
.......-..\........../..................-........\...........|..|.....\...-.....\../.-..\.....-.||...|..-.....
/./....../|...................-............/.....|..-..................................|........./\....-......
................/............................/......-...\...............................\..........-....-....|
.........\.....\......-.....\.........................-............./........./......\...................\....
.....................|...................|...........-............./........\.........../.................\...
........................................../................-|.......||....\...|......\........................
|..-.../|......-............-.....||...|...........-./....................../...\....\-........//......\......
../.-......../........./.-..|..|....||........./......-..\................../.....|.....|...|....|\...........
.-/..\...........\........\...............\..................|......../............-...........-..........|...
...|..|................|............./\....-....-...-......-......-................-................/........|
..-....\....|...../..........|..-./.\......./|.........\.....-|.......\.......................-...|...........
-.......\\...................-....\|........|............|.......................\.............\....../....\./
-......................................../.............-./\.........\.|......./|......../.....|...............
........-.\\\...............-.../............\.................||.............../../..........................
.....................\............\............................-..|.........\......................../........
\..././.....|....|.....-............\./....-.............|..-...-..........-.|....-...\..........|....\.......
.|..........|.....|.......\................................../......./.../...|....\...-..-...\................
..\...\......-..........................................-.........../........--..........--......|............
................................||...-.....|.....-.\..............\.|...\...............-...-.................
............................../..\..|....../.......\......\...-..|../............-.......................\..\.
./............./..|.......|............-.........|.......\../...................|....\...................../..
.|...................|\...................|.....................-.......\...|................-|...............
/|......./../.........\.................\............../.../......|....|......./....|-..........\.............
............|....\.............-.....-./|/.................../......./.\...-.........-..................|.....
.-.../..........................\\.......|.......|.....-........../........\.................|.|..............
....-.\....................../.-......||................/\\.........../..............|........................
\/.....\....-......|...................|.\......\.|............/...\.|.../................|.\.................
..-.\...............-......../.......\....../........-.......-\....../......|../..................|../........
..-./..........\.....................................|.........-.......|................/........|............
.............-....../......./......................|.............../............\..../........................
..|......-........|...................-...........|............../........................|../................
..../..........|-.....-......./....../......./.\.....\.........-...|......................................\...
....\......../..................../..-......|..............-.................||...........\.\...|/............
........\.............|.................................\......./.............-.......|..............\.-......
.....|...........-.............|..........-......\..................................|..-............\.../.\.-.
..................................\...........\...\.......\................\-.................../.............
......-............../...........-......\./..........|..\..................|...|....|...|-./..............|...
........\..|.\......................../..........\..........\.|..|../....\..|.....|.|..............\..-.......
...........-..........|..../.-........../..................|......./.................\.............../........
..........-..../\....\........./............/..................\..........-/................................//
.............-../.-.............\.............../-....-....|..../.............|...............................
........./............|....................|./........\...../................................-.......|........
........./..../..........\..\.....././.........|...........\..................../....../...\.........../.../..
.-....\.........\....-............/...................-.....|.....................|...........................
................-.......................|.........|.................................................\.......|.
...../............|....//...../................|.\...........|............\.....|-........|.........\.........
\..././-....................|...................-..............-..............|.........|....|............./..
..-...........................././-./...\-.................|...-.....-/........\....|............\-..-........
...............|...............//........../.......-.-......................-.........|.............\.........
../............/..................\\......../............................\................../........./.......
......|.\...............................................|................................/.........-.-........
....\.\...\..................-..-.................\\.....-....|................\.................|............
........................./.............-...|./.................\....|....\..|...|..........\-.................
..........|.............\..................\..................../.\.......|..................\/......|........
............|....\..\..../...........-....\....................\...........................-../...............
.....................|......../.././.............\......|.-......\.............-../...|...............-......|
..................-...................................................-.............\............./.|......-..
...\.............||...........................\........\......-......-..\...\...\............./-...........|..
...\........|...................|.......|.............|..-......../..-...-............/.........\....|........
......-...........|................./......|.....-./|..\\...............\|././...............-........\....\..
"""#
)

